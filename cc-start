#!/bin/bash
# Start a new Claude Code instance or attach to existing one
# Usage: ./cc-start [instance-name] [--branch branch-name]
# If no name provided, generates a random name like "happy-tiger"

set -e

# Determine script directory early (needed for sourcing .env and finding project files)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source .env to read project configuration (GIT_REPO_URL, NPM_INSTALL_DIR, etc.)
if [ -f "$SCRIPT_DIR/.env" ]; then
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
fi

# Parse arguments
INSTANCE_NAME=""
GIT_BRANCH_OVERRIDE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --branch)
            GIT_BRANCH_OVERRIDE="$2"
            shift 2
            ;;
        *)
            INSTANCE_NAME="$1"
            shift
            ;;
    esac
done

# Get instance name from argument or generate a random one
if [ -z "$INSTANCE_NAME" ]; then
    # Generate a nice random name (adjective-noun combination)
    ADJECTIVES=(happy swift clever bright calm cool bold quick wise gentle noble proud brave kind)
    NOUNS=(tiger lion eagle fox wolf bear hawk deer owl raven falcon dolphin dragon phoenix)

    # Get random indices
    ADJ_INDEX=$((RANDOM % ${#ADJECTIVES[@]}))
    NOUN_INDEX=$((RANDOM % ${#NOUNS[@]}))

    INSTANCE_NAME="${ADJECTIVES[$ADJ_INDEX]}-${NOUNS[$NOUN_INDEX]}"
fi

PROJECT_NAME="claude-${INSTANCE_NAME}"
CONTAINER_NAME="${PROJECT_NAME}-claude-code-1"

echo "ðŸš€ Starting Claude Code instance: $INSTANCE_NAME"
echo "   Project: $PROJECT_NAME"
echo ""

# Build environment override for branch if specified
ENV_OVERRIDE=""
if [ -n "$GIT_BRANCH_OVERRIDE" ]; then
    ENV_OVERRIDE="-e GIT_BRANCH=$GIT_BRANCH_OVERRIDE"
    echo "ðŸ“Œ Using branch: $GIT_BRANCH_OVERRIDE"
    echo ""
fi

# Check if container already exists and is running
if docker ps -q -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
    echo "âœ“ Container already running"
    
    # Copy Claude instructions if they exist locally
    if [ -f "$HOME/.claude/CLAUDE.md" ]; then
        echo "  Copying Claude instructions..."
        docker-compose -p "$PROJECT_NAME" exec -T claude-code mkdir -p /home/node/.claude
        docker cp "$HOME/.claude/CLAUDE.md" "${CONTAINER_NAME}:/home/node/.claude/CLAUDE.md"
    fi

    # Copy skills from repo if they exist
    if [ -d "$SCRIPT_DIR/.claude/skills" ]; then
        echo "  Copying skills..."
        docker cp "$SCRIPT_DIR/.claude/skills" "${CONTAINER_NAME}:/home/node/.claude/skills"
    fi

    # Copy settings.json from repo if it exists
    if [ -f "$SCRIPT_DIR/.claude/settings.json" ]; then
        echo "  Copying settings..."
        docker cp "$SCRIPT_DIR/.claude/settings.json" "${CONTAINER_NAME}:/home/node/.claude/settings.json"
    fi

    # Copy project .env file if it exists
    ENV_SOURCE="${PROJECT_ENV_FILE:-$SCRIPT_DIR/project.env}"
    if [ -f "$ENV_SOURCE" ]; then
        # Determine repo directory inside container
        if [ -n "$GIT_CLONE_DIR" ]; then
            REPO_DIR="$GIT_CLONE_DIR"
        elif [ -n "$GIT_REPO_URL" ]; then
            REPO_DIR=$(basename "$GIT_REPO_URL" .git)
        fi
        if [ -n "$REPO_DIR" ]; then
            ENV_DEST_DIR="${PROJECT_ENV_DEST:-$NPM_INSTALL_DIR}"
            if [ -n "$ENV_DEST_DIR" ]; then
                ENV_DEST="/workspace/$REPO_DIR/$ENV_DEST_DIR/.env"
            else
                ENV_DEST="/workspace/$REPO_DIR/.env"
            fi
            echo "  Copying project .env to $ENV_DEST..."
            docker cp "$ENV_SOURCE" "${CONTAINER_NAME}:${ENV_DEST}"
        fi
    fi

    echo "  Connecting to existing instance..."
    echo ""
    docker-compose -p "$PROJECT_NAME" exec -it claude-code /entrypoint.sh claude
else
    # Check if container exists but is stopped
    if docker ps -aq -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
        echo "âœ“ Container exists but stopped"
        echo "  Starting existing container..."
        docker-compose -p "$PROJECT_NAME" start
    else
        echo "âœ“ Creating new container..."
        if [ -n "$ENV_OVERRIDE" ]; then
            docker-compose -p "$PROJECT_NAME" run -d --service-ports --name "$CONTAINER_NAME" $ENV_OVERRIDE claude-code tail -f /dev/null
        else
            docker-compose -p "$PROJECT_NAME" up -d
        fi

        # Wait for initial repository setup to complete
        # Dependency installation will continue in background
        echo ""
        echo "â³ Setting up repository..."
        echo ""

        # Follow logs until clone/pull is complete
        docker logs -f "$CONTAINER_NAME" 2>&1 | while IFS= read -r line; do
            echo "   $line"
            # Break when clone is complete - let dependencies install in background
            if echo "$line" | grep -q "Repository cloned successfully!"; then
                break
            fi
            # Break when pre-cloned repo is ready (pull completed)
            if echo "$line" | grep -q "Repository ready (pre-cloned)"; then
                break
            fi
            # Also handle case where no git repo is configured
            if echo "$line" | grep -q "No git repository configured"; then
                break
            fi
        done

        echo ""
        echo "âœ“ Repository ready"
        echo "  (Dependencies are installing in background)"
    fi

    echo ""

    # Copy Claude instructions if they exist locally
    if [ -f "$HOME/.claude/CLAUDE.md" ]; then
        echo "  Copying Claude instructions..."
        sleep 1  # Wait for container to be fully ready
        docker cp "$HOME/.claude/CLAUDE.md" "${CONTAINER_NAME}:/home/node/.claude/CLAUDE.md" 2>/dev/null || echo "  (Could not copy instructions, continuing anyway...)"
    fi

    # Copy skills from repo if they exist
    if [ -d "$SCRIPT_DIR/.claude/skills" ]; then
        echo "  Copying skills..."
        docker cp "$SCRIPT_DIR/.claude/skills" "${CONTAINER_NAME}:/home/node/.claude/skills" 2>/dev/null || echo "  (Could not copy skills, continuing anyway...)"
    fi

    # Copy settings.json from repo if it exists
    if [ -f "$SCRIPT_DIR/.claude/settings.json" ]; then
        echo "  Copying settings..."
        docker cp "$SCRIPT_DIR/.claude/settings.json" "${CONTAINER_NAME}:/home/node/.claude/settings.json" 2>/dev/null || echo "  (Could not copy settings, continuing anyway...)"
    fi

    # Copy project .env file if it exists
    ENV_SOURCE="${PROJECT_ENV_FILE:-$SCRIPT_DIR/project.env}"
    if [ -f "$ENV_SOURCE" ]; then
        # Determine repo directory inside container
        if [ -n "$GIT_CLONE_DIR" ]; then
            REPO_DIR="$GIT_CLONE_DIR"
        elif [ -n "$GIT_REPO_URL" ]; then
            REPO_DIR=$(basename "$GIT_REPO_URL" .git)
        fi
        if [ -n "$REPO_DIR" ]; then
            ENV_DEST_DIR="${PROJECT_ENV_DEST:-$NPM_INSTALL_DIR}"
            if [ -n "$ENV_DEST_DIR" ]; then
                ENV_DEST="/workspace/$REPO_DIR/$ENV_DEST_DIR/.env"
            else
                ENV_DEST="/workspace/$REPO_DIR/.env"
            fi
            echo "  Copying project .env to $ENV_DEST..."
            docker cp "$ENV_SOURCE" "${CONTAINER_NAME}:${ENV_DEST}" 2>/dev/null || echo "  (Could not copy project .env, continuing anyway...)"
        fi
    fi

    echo "  Launching Claude Code..."
    echo ""
    docker-compose -p "$PROJECT_NAME" exec $ENV_OVERRIDE -it claude-code /entrypoint.sh claude
fi
