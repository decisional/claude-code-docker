#!/bin/bash
# Start a new Claude Code instance or attach to existing one
# Usage: ./cc-start [instance-name]

set -e

INSTANCE_NAME="$1"

# Generate random name if not provided
if [ -z "$INSTANCE_NAME" ]; then
    ADJECTIVES=(happy swift clever bright calm cool bold quick wise gentle noble proud brave kind)
    NOUNS=(tiger lion eagle fox wolf bear hawk deer owl raven falcon dolphin dragon phoenix)
    INSTANCE_NAME="${ADJECTIVES[$((RANDOM % ${#ADJECTIVES[@]}))]}-${NOUNS[$((RANDOM % ${#NOUNS[@]}))]}"
fi

PROJECT_NAME="claude-${INSTANCE_NAME}"
CONTAINER_NAME="${PROJECT_NAME}-claude-code-1"

echo "ðŸš€ Starting Claude Code: $INSTANCE_NAME"

# Check if container already running
if docker ps -q -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
    echo "âœ“ Container running, connecting..."
    [ -f "$HOME/.claude/CLAUDE.md" ] && docker cp "$HOME/.claude/CLAUDE.md" "${CONTAINER_NAME}:/home/node/.claude/CLAUDE.md" 2>/dev/null || true
    docker-compose -p "$PROJECT_NAME" exec -it claude-code /entrypoint.sh claude
elif docker ps -aq -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
    echo "âœ“ Starting stopped container..."
    docker-compose -p "$PROJECT_NAME" start
    [ -f "$HOME/.claude/CLAUDE.md" ] && docker cp "$HOME/.claude/CLAUDE.md" "${CONTAINER_NAME}:/home/node/.claude/CLAUDE.md" 2>/dev/null || true
    docker-compose -p "$PROJECT_NAME" exec -it claude-code /entrypoint.sh claude
else
    echo "âœ“ Creating new container..."
    docker-compose -p "$PROJECT_NAME" up -d

    echo "â³ Setting up..."
    docker logs -f "$CONTAINER_NAME" 2>&1 | while IFS= read -r line; do
        echo "   $line"
        echo "$line" | grep -q "âœ“ Cloned\|Repository exists\|No GIT_REPO_URL" && break
    done

    [ -f "$HOME/.claude/CLAUDE.md" ] && docker cp "$HOME/.claude/CLAUDE.md" "${CONTAINER_NAME}:/home/node/.claude/CLAUDE.md" 2>/dev/null || true
    echo ""
    docker-compose -p "$PROJECT_NAME" exec -it claude-code /entrypoint.sh claude
fi
