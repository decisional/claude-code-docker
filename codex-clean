#!/bin/bash
# Remove all Codex CLI instances (stopped and running)
# Usage: ./codex-clean [--force]
# --force: skip confirmation prompt

set -e

FORCE=false
if [ "$1" = "--force" ]; then
    FORCE=true
fi

echo "üßπ Cleaning all Codex CLI instances"
echo "========================================"
echo ""

# Get ALL codex instances (running + stopped)
ALL_CONTAINERS=$(docker ps -a --filter "name=codex-" --filter "name=-claude-code-1" --format "{{.Names}} {{.Status}}" | grep "^codex-" || true)

# Check if there are any containers
if [ -z "$ALL_CONTAINERS" ]; then
    echo "‚úì No instances found. Nothing to clean."
    exit 0
fi

# Count instances
INSTANCE_COUNT=$(echo "$ALL_CONTAINERS" | wc -l | tr -d ' ')
echo "Found $INSTANCE_COUNT instance(s):"
echo ""

# List instances with status
while IFS= read -r line; do
    CONTAINER_NAME=$(echo "$line" | awk '{print $1}')
    STATUS=$(echo "$line" | cut -d' ' -f2-)
    INSTANCE_NAME=$(echo "$CONTAINER_NAME" | sed 's/^codex-//' | sed 's/-claude-code-1$//')
    echo "  ‚óã $INSTANCE_NAME ($STATUS)"
done <<< "$ALL_CONTAINERS"
echo ""

# Ask for confirmation unless --force
if [ "$FORCE" = false ]; then
    read -p "Remove all instances? (y/N): " CONFIRM
    if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
        echo "‚ùå Cancelled"
        exit 0
    fi
    echo ""
fi

echo "Removing instances..."
echo ""

# Remove each instance
while IFS= read -r line; do
    CONTAINER_NAME=$(echo "$line" | awk '{print $1}')
    INSTANCE_NAME=$(echo "$CONTAINER_NAME" | sed 's/^codex-//' | sed 's/-claude-code-1$//')

    echo "  üóëÔ∏è  Removing: $INSTANCE_NAME"
    docker stop "$CONTAINER_NAME" 2>/dev/null || true
    docker rm "$CONTAINER_NAME" 2>/dev/null || echo "     ‚ö†Ô∏è  Warning: Could not remove $INSTANCE_NAME"
done <<< "$ALL_CONTAINERS"

echo ""
echo "‚úì Cleanup complete!"
