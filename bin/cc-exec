#!/bin/bash
# Resume/connect to an existing Claude Code instance
# Usage: cc-exec [instance-name]
# If no name provided, uses current directory name

set -e

# Source config functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/config-functions.sh"

# Get instance name from argument or use current directory name
INSTANCE_NAME=$(get_instance_name "$1")

PROJECT_NAME="claude-${INSTANCE_NAME}"
CONTAINER_NAME="${PROJECT_NAME}-claude-code-1"

echo "üîå Connecting to Claude Code instance: $INSTANCE_NAME"
echo ""

# Check if container exists and is running
if docker ps -q -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
    docker-compose -f "$LIB_DIR/docker-compose.yml" -p "$PROJECT_NAME" exec -it claude-code /entrypoint.sh claude
else
    if docker ps -aq -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
        echo "‚ùå Container exists but is not running"
        echo "   Use 'cc-start $INSTANCE_NAME' to start it"
    else
        echo "‚ùå No container found for instance: $INSTANCE_NAME"
        echo "   Use 'cc-start $INSTANCE_NAME' to create it"
        echo ""
        echo "Available instances:"
        docker ps -a --filter "name=claude-" --format "  - {{.Names}}" | sed 's/-claude-code-1//' | sed 's/claude-//'
    fi
    exit 1
fi
