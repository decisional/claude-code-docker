#!/bin/bash
# Remove all stopped Claude Code instances
# Usage: ./cc-clean

set -e

echo "ðŸ§¹ Cleaning stopped Claude Code instances"
echo "=========================================="
echo ""

# Get all stopped instances
STOPPED_CONTAINERS=$(docker ps -a --filter "name=claude-" --filter "status=exited" --format "{{.Names}}")

# Check if there are any stopped containers
if [ -z "$STOPPED_CONTAINERS" ]; then
    echo "âœ“ No stopped instances found. Nothing to clean."
    exit 0
fi

# Count stopped instances
INSTANCE_COUNT=$(echo "$STOPPED_CONTAINERS" | wc -l | tr -d ' ')
echo "Found $INSTANCE_COUNT stopped instance(s):"
echo ""

# List stopped instances
echo "$STOPPED_CONTAINERS" | sed 's/-claude-code-1//' | sed 's/claude-//' | awk '{print "  â—‹ " $0}'
echo ""

# Ask for confirmation
read -p "Remove all stopped instances? (y/N): " CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "âŒ Cancelled"
    exit 0
fi

echo ""
echo "Removing stopped instances..."
echo ""

# Remove each stopped instance
while IFS= read -r CONTAINER_NAME; do
    # Extract instance name from container name
    # claude-my-project-claude-code-1 -> my-project
    INSTANCE_NAME=$(echo "$CONTAINER_NAME" | sed 's/^claude-//' | sed 's/-claude-code-1$//')
    PROJECT_NAME="claude-${INSTANCE_NAME}"

    echo "  ðŸ—‘ï¸  Removing: $INSTANCE_NAME"
    docker-compose -p "$PROJECT_NAME" down 2>/dev/null || echo "     âš ï¸  Warning: Could not remove $INSTANCE_NAME"
    NETWORK_NAME="${PROJECT_NAME}_default"
    docker network rm "$NETWORK_NAME" 2>/dev/null || true
done <<< "$STOPPED_CONTAINERS"

echo ""
echo "Pruning orphaned networks..."
docker network prune -f 2>/dev/null | grep -v "^$" || true

echo ""
echo "âœ“ Cleanup complete!"
