#!/bin/bash
# Create pull request with detailed description

set -e

STATE_DIR=$1

if [ -z "$STATE_DIR" ]; then
    echo "Error: STATE_DIR required"
    echo "Usage: $0 <state-dir>"
    exit 1
fi

TICKET_ID=$(basename "$STATE_DIR")
PLAN_FILE="$STATE_DIR/plan.md"
RESPONSE_FILE="$STATE_DIR/executor-response.md"
REVIEW_FILE="$STATE_DIR/review.md"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  CREATING PULL REQUEST"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Change to repository directory
cd /workspace/autodex

# Determine branch name
BRANCH_NAME="workflow-$(echo $TICKET_ID | tr '[:upper:]' '[:lower:]')"

# Check current iteration from state
ITERATION=$(jq -r '.iteration // 0' "$STATE_DIR/../$TICKET_ID/workflow-state.json" 2>/dev/null || echo "0")

echo "Iteration: $ITERATION"

# Check if we're already on a branch or need to create one
CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" != "$BRANCH_NAME" ] && [ "$CURRENT_BRANCH" != "main" ]; then
    echo "Already on branch: $CURRENT_BRANCH"
    BRANCH_NAME="$CURRENT_BRANCH"
elif [ "$CURRENT_BRANCH" = "main" ]; then
    echo "Creating new branch: $BRANCH_NAME"

    # Fetch latest main
    echo "Fetching latest changes from main..."
    git fetch origin main

    # Create and checkout new branch from latest main
    git checkout -b "$BRANCH_NAME" origin/main
else
    echo "Using existing branch: $BRANCH_NAME"
fi

# Check if there are changes to commit
if git diff --quiet && git diff --cached --quiet; then
    echo "Warning: No changes to commit"
    exit 1
fi

# Stage all changes
echo "Staging changes..."
git add -A

# Create commit message from ticket and plan
TICKET_TITLE=$(grep -m 1 "^**Title:**" "$STATE_DIR/linear-ticket.md" | sed 's/\*\*Title:\*\* //' || echo "Implement $TICKET_ID")

if [ "$ITERATION" -eq 0 ]; then
    # Initial commit
    COMMIT_MSG=$(cat <<EOF
$TICKET_TITLE

Automated implementation for Linear ticket: $TICKET_ID

This PR was generated by the autonomous workflow system.

Changes implemented according to the plan.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
    )
else
    # Iteration commit addressing review feedback
    COMMIT_MSG=$(cat <<EOF
Address review feedback (iteration $ITERATION)

Implementing changes requested by reviewer agent.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
    )
fi

# Commit changes
echo "Creating commit (iteration $ITERATION)..."
git commit -m "$COMMIT_MSG"

# Push to remote
echo "Pushing to remote..."
git push -u origin "$BRANCH_NAME"

# Build PR description from workflow artifacts
echo "Building PR description..."

PLAN_SUMMARY=""
if [ -f "$PLAN_FILE" ]; then
    PLAN_SUMMARY=$(sed -n '/## Overview/,/##/p' "$PLAN_FILE" | head -n -1)
fi

EXECUTION_SUMMARY=""
if [ -f "$RESPONSE_FILE" ]; then
    EXECUTION_SUMMARY=$(cat "$RESPONSE_FILE")
fi

REVIEW_SUMMARY=""
if [ -f "$REVIEW_FILE" ]; then
    REVIEW_SUMMARY=$(cat "$REVIEW_FILE")
fi

PR_BODY=$(cat <<'HEREDOC_EOF'
# Autonomous Workflow Implementation

## Linear Ticket
Implements: %TICKET_ID%

## Plan Overview
%PLAN_SUMMARY%

## Implementation Summary
%EXECUTION_SUMMARY%

## Code Review
%REVIEW_SUMMARY%

---

ðŸ¤– This PR was autonomously generated by the multi-agent workflow system:
- **Planner Agent** (Codex): Created implementation plan
- **Executor Agent** (Claude): Implemented changes
- **Reviewer Agent** (Codex): Reviewed and approved changes

Generated with [Claude Code](https://claude.com/claude-code)
HEREDOC_EOF
)

# Substitute values
PR_BODY=$(echo "$PR_BODY" | sed "s|%TICKET_ID%|$TICKET_ID|g")
PR_BODY=$(echo "$PR_BODY" | awk -v plan="$PLAN_SUMMARY" '{gsub(/%PLAN_SUMMARY%/, plan)}1')
PR_BODY=$(echo "$PR_BODY" | awk -v exec="$EXECUTION_SUMMARY" '{gsub(/%EXECUTION_SUMMARY%/, exec)}1')
PR_BODY=$(echo "$PR_BODY" | awk -v review="$REVIEW_SUMMARY" '{gsub(/%REVIEW_SUMMARY%/, review)}1')

# Only create PR on first iteration, otherwise just push commits
if [ "$ITERATION" -eq 0 ]; then
    # Create PR using gh CLI
    echo "Creating draft pull request..."

    if ! command -v gh &> /dev/null; then
        echo "Error: gh CLI not found. Cannot create PR automatically."
        echo "Please create PR manually for branch: $BRANCH_NAME"
        exit 1
    fi

    # Check if already authenticated
    if ! gh auth status &> /dev/null; then
        echo "Error: gh CLI not authenticated"
        echo "Please set GITHUB_TOKEN in .env file"
        exit 1
    fi

    # Create DRAFT PR
    PR_URL=$(gh pr create \
        --draft \
        --title "$TICKET_TITLE" \
        --body "$PR_BODY" \
        --base main \
        --head "$BRANCH_NAME" 2>&1)

    if [ $? -eq 0 ]; then
        echo ""
        echo "âœ“ Draft pull request created successfully!"
        echo "  URL: $PR_URL"
        echo "  Status: DRAFT (will be marked ready after review approval)"
        echo ""
    else
        # Try to extract URL even if command had warnings
        if echo "$PR_URL" | grep -q "https://"; then
            EXTRACTED_URL=$(echo "$PR_URL" | grep -o 'https://[^ ]*' | head -n 1)
            echo ""
            echo "âœ“ Draft pull request created!"
            echo "  URL: $EXTRACTED_URL"
            echo ""
        else
            echo ""
            echo "Error creating pull request:"
            echo "$PR_URL"
            exit 1
        fi
    fi
else
    # Iteration > 0: Just push commits to existing PR
    echo ""
    echo "âœ“ Changes pushed to existing PR"
    echo "  Branch: $BRANCH_NAME"
    echo "  Iteration: $ITERATION"
    echo ""

    # Try to get PR URL
    if command -v gh &> /dev/null && gh auth status &> /dev/null; then
        PR_URL=$(gh pr list --head "$BRANCH_NAME" --json url --jq '.[0].url' 2>/dev/null || echo "")
        if [ -n "$PR_URL" ]; then
            echo "  PR URL: $PR_URL"
        fi
    fi
    echo ""
fi

exit 0
