#!/bin/bash
# Start a new Codex CLI instance or attach to existing one
# Usage: ./codex-start [instance-name]

set -e

INSTANCE_NAME="$1"

# Generate random name if not provided
if [ -z "$INSTANCE_NAME" ]; then
    ADJECTIVES=(happy swift clever bright calm cool bold quick wise gentle noble proud brave kind)
    NOUNS=(tiger lion eagle fox wolf bear hawk deer owl raven falcon dolphin dragon phoenix)
    INSTANCE_NAME="${ADJECTIVES[$((RANDOM % ${#ADJECTIVES[@]}))]}-${NOUNS[$((RANDOM % ${#NOUNS[@]}))]}"
fi

PROJECT_NAME="codex-${INSTANCE_NAME}"
CONTAINER_NAME="${PROJECT_NAME}-claude-code-1"
ENV_OVERRIDE="-e LLM_TYPE=codex"

echo "ðŸš€ Starting Codex CLI: $INSTANCE_NAME"

# Check if container already running
if docker ps -q -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
    echo "âœ“ Container running, connecting..."
    [ -d "$HOME/.openai" ] && docker cp "$HOME/.openai" "${CONTAINER_NAME}:/home/node/.openai" 2>/dev/null || true
    docker-compose -p "$PROJECT_NAME" exec $ENV_OVERRIDE -it claude-code /entrypoint.sh codex
elif docker ps -aq -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
    echo "âœ“ Starting stopped container..."
    docker-compose -p "$PROJECT_NAME" start
    [ -d "$HOME/.openai" ] && docker cp "$HOME/.openai" "${CONTAINER_NAME}:/home/node/.openai" 2>/dev/null || true
    docker-compose -p "$PROJECT_NAME" exec $ENV_OVERRIDE -it claude-code /entrypoint.sh codex
else
    echo "âœ“ Creating new container..."
    docker-compose -p "$PROJECT_NAME" run -d --name "$CONTAINER_NAME" $ENV_OVERRIDE claude-code tail -f /dev/null

    echo "â³ Setting up..."
    docker logs -f "$CONTAINER_NAME" 2>&1 | while IFS= read -r line; do
        echo "   $line"
        echo "$line" | grep -q "âœ“ Cloned\|Repository exists\|No GIT_REPO_URL" && break
    done

    [ -d "$HOME/.openai" ] && docker cp "$HOME/.openai" "${CONTAINER_NAME}:/home/node/.openai" 2>/dev/null || true
    echo ""
    docker-compose -p "$PROJECT_NAME" exec $ENV_OVERRIDE -it claude-code /entrypoint.sh codex
fi
