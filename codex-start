#!/bin/bash
# Start a new Codex CLI instance or attach to existing one
# Usage: ./codex-start [instance-name] [--branch branch-name]
# If no name provided, generates a random name like "happy-tiger"

set -e

# Parse arguments
INSTANCE_NAME=""
GIT_BRANCH_OVERRIDE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --branch)
            GIT_BRANCH_OVERRIDE="$2"
            shift 2
            ;;
        *)
            INSTANCE_NAME="$1"
            shift
            ;;
    esac
done

# Get instance name from argument or generate a random one
if [ -z "$INSTANCE_NAME" ]; then
    # Generate a nice random name (adjective-noun combination)
    ADJECTIVES=(happy swift clever bright calm cool bold quick wise gentle noble proud brave kind)
    NOUNS=(tiger lion eagle fox wolf bear hawk deer owl raven falcon dolphin dragon phoenix)

    # Get random indices
    ADJ_INDEX=$((RANDOM % ${#ADJECTIVES[@]}))
    NOUN_INDEX=$((RANDOM % ${#NOUNS[@]}))

    INSTANCE_NAME="${ADJECTIVES[$ADJ_INDEX]}-${NOUNS[$NOUN_INDEX]}"
fi

PROJECT_NAME="codex-${INSTANCE_NAME}"
CONTAINER_NAME="${PROJECT_NAME}-claude-code-1"

echo "ðŸš€ Starting Codex CLI instance: $INSTANCE_NAME"
echo "   Project: $PROJECT_NAME"
echo ""

# Build environment override for branch if specified
ENV_OVERRIDE="-e LLM_TYPE=codex"
if [ -n "$GIT_BRANCH_OVERRIDE" ]; then
    ENV_OVERRIDE="$ENV_OVERRIDE -e GIT_BRANCH=$GIT_BRANCH_OVERRIDE"
    echo "ðŸ“Œ Using branch: $GIT_BRANCH_OVERRIDE"
    echo ""
fi

# Check if container already exists and is running
if docker ps -q -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
    echo "âœ“ Container already running"

    # Copy OpenAI config if it exists locally
    if [ -d "$HOME/.openai" ]; then
        echo "  Copying OpenAI configuration..."
        docker cp "$HOME/.openai" "${CONTAINER_NAME}:/home/node/.openai" 2>/dev/null || true
    fi

    echo "  Connecting to existing instance..."
    echo ""
    docker-compose -p "$PROJECT_NAME" exec $ENV_OVERRIDE -it claude-code /entrypoint.sh codex
else
    # Check if container exists but is stopped
    if docker ps -aq -f name="^${CONTAINER_NAME}$" 2>/dev/null | grep -q .; then
        echo "âœ“ Container exists but stopped"
        echo "  Starting existing container..."
        docker-compose -p "$PROJECT_NAME" start
    else
        echo "âœ“ Creating new container..."
        docker-compose -p "$PROJECT_NAME" run -d --service-ports --name "$CONTAINER_NAME" $ENV_OVERRIDE claude-code tail -f /dev/null

        # Wait for initial repository setup to complete
        # Dependency installation will continue in background
        echo ""
        echo "â³ Setting up repository..."
        echo ""

        # Follow logs until clone/pull is complete
        docker logs -f "$CONTAINER_NAME" 2>&1 | while IFS= read -r line; do
            echo "   $line"
            # Break when clone is complete - let dependencies install in background
            if echo "$line" | grep -q "Repository cloned successfully!"; then
                break
            fi
            # Break when pre-cloned repo is ready (pull completed)
            if echo "$line" | grep -q "Repository ready (pre-cloned)"; then
                break
            fi
            # Also handle case where no git repo is configured
            if echo "$line" | grep -q "No git repository configured"; then
                break
            fi
        done

        echo ""
        echo "âœ“ Repository ready"
        echo "  (Dependencies are installing in background)"
    fi

    echo ""

    # Copy OpenAI config if it exists locally
    if [ -d "$HOME/.openai" ]; then
        echo "  Copying OpenAI configuration..."
        sleep 1  # Wait for container to be fully ready
        docker cp "$HOME/.openai" "${CONTAINER_NAME}:/home/node/.openai" 2>/dev/null || echo "  (Could not copy OpenAI config, continuing anyway...)"
    fi

    echo "  Launching Codex CLI..."
    echo ""
    docker-compose -p "$PROJECT_NAME" exec $ENV_OVERRIDE -it claude-code /entrypoint.sh codex
fi
